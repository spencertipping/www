<!doctype html>
<html>
<head>
<meta charset='utf-8'/>
<style>
/* Blog stylesheet | Spencer Tipping*/
/* Licensed under the terms of the MIT source code license*/

body {font-family: 'Sans', sans-serif; font-size: 9pt; line-height: 1.44em; margin: 0 auto; max-width: 80ex}

a {color: #35a; text-decoration: none}
a:hover {text-decoration: underline}
a:visited {color: #89a}

#header {position: absolute; right: 0; top: 0; padding: 10px; text-align: right; font-size: 8pt}
#header h3 {font-size: 8pt; font-weight: normal}
#header ul {list-style-type: none}

#contents {padding: 10px 0}
#contents h1, #contents h2, #contents h3, #contents h4 {font-weight: normal; font-size: 14pt; text-transform: lowercase; margin: 0; padding: 10px 0}
#contents h2 {font-size: 10pt; color: #000; text-transform: uppercase}
#contents h3 {font-size: 10pt; color: #444; text-transform: uppercase} #contents h3:before {content: '> '; color: #888}
#contents h4 {font-size: 10pt; color: #888; text-transform: uppercase} #contents h4:before {content: '> '; color: #ccc}

#contents em {color: #444}

#contents .date      {color: #888; font-size: 10pt; font-family: 'Droid Sans Mono', 'Monospace', 'Liberation Mono', monospace; float: right; margin-top: 1em}
#contents .permalink {font-size: 10pt; float: right; margin-top: 1em}
#contents .permalink a {color: #888}
#contents .permalink a:after {color: #ccc; content: '|'}

td, th {text-align: right; border-right: solid 1px #ccc}

/* Generated by SDoc */

</style>
<link rel='alternate' href='feed.atom' type='application/atom+xml' title='Atom feed'/>
</head>
<body>
<div id='header' role='banner'>
<div><a href='http://twitter.com/spencertipping' aria-label='Twitter handle'>@spencertipping</a></div>
<div><a href='http://github.com/spencertipping' aria-label='Github profile'>github.com/spencertipping</a></div>
<div><a href='http://github.com/spencertipping/plain-blog'>Blog source</a></div>
<div><a href='http://spencertipping.com/zeroconsulting'>Zero-risk consulting</a></div>
<div><a href='http://spencertipping.com/feed.atom'>Atom feed</a></div>

<h3><label for='family'>Family</label></h3>
<ul id='family'>
<li><a href='http://joycetipping.com'>Joyce (my wife)</a></li>
<li><a href='http://adamtipping.com'>Adam (our son)</a></li>
</ul>

<h3><label for='projects'>Projects</label></h3>
<ul id='projects'>
<li><a href='http://github.com/spencertipping/cd'>cd</a></li>
<li><a href='http://github.com/spencertipping/perl-objects'>Self-modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/flotsam'>Flotsam</a></li>
<li><a href='http://github.com/spencertipping/js-instabench'>Javascript Instabench</a></li>
<li><a href='http://spencertipping.com/cheloniidae'>Cheloniidae</a></li>
<li><a href='http://github.com/spencertipping/sdoc'>SDoc</a></li>
<li><a href='http://github.com/spencertipping/bash-prompt'>Bash prompt</a></li>
<li><a href='http://github.com/spencertipping/rather-insane-serialization'>Rather Insane Serialization</a></li>
<li><a href='http://github.com/spencertipping/infuse'>Infuse JS</a></li>
<li><a href='http://github.com/spencertipping/browserpower'>Browserpower</a></li>
<li><a href='http://github.com/spencertipping/perlquery'>Perlquery</a></li>
<li><a href='http://github.com/spencertipping/cheloniidae-live'>Cheloniidae Live</a></li>
</ul>

<h3><label for='moreprojects'>Misguided but fun</label></h3>
<ul id='moreprojects'>
<li><a href='http://github.com/spencertipping/canard'>Canard</a></li>
<li><a href='http://github.com/spencertipping/caterwaul'>Caterwaul JS</a></li>
<li><a href='http://github.com/spencertipping/bash-lambda'>Bash-lambda</a></li>
<li><a href='http://github.com/spencertipping/catastrophe'>Catastrophe</a></li>
<li><a href='http://github.com/spencertipping/mulholland'>Mulholland</a></li>
</ul>

<h3><label for='quizzes'>Web quizzes</label></h3>
<ul id='quizzes'>
<li><a href='http://spencertipping.com/pl-quiz.html'>Programming language quiz</a></li>
<li><a href='http://spencertipping.com/js-quiz.html'>Javascript quiz</a></li>
</ul>

<h3><label for='pdfs'>PDFs</label></h3>
<ul id='pdfs'>
<li><a href='http://github.com/spencertipping/js-in-ten-minutes'>Javascript in Ten Minutes</a></li>
<li><a href='http://github.com/spencertipping/writing-self-modifying-perl'>Writing Self-Modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/git-in-ten-minutes'>Git in Ten Minutes</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-by-example.pdf'>Caterwaul by Example</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-reference-manual.pdf'>Caterwaul Reference Manual</a></li>
<li><a href='http://spencertipping.com/cheloniidae/cheloniidae.pdf'>Cheloniidae literate source</a></li>
<li><a href='http://spencertipping.com/mathbio2008/model.pdf'>MathBio model literate source</a></li>
</ul>

<h3><label for='jquery-modules'>jQuery modules</label></h3>
<ul id='jquery-modules'>
<li><a href='http://github.com/spencertipping/modus'>Modus (uses Caterwaul)</a></li>
<li><a href='http://github.com/spencertipping/jquery.instavalidate'>Instavalidate</a></li>
<li><a href='http://github.com/spencertipping/jquery.gaussian'>Gaussian blur</a></li>
<li><a href='http://github.com/spencertipping/jquery.fix.clone'>clone() patch</a></li>
</ul>

<h3><label for='caterwaul-modules'>Caterwaul modules</label></h3>
<ul id='caterwaul-modules'>
<li><a href='http://github.com/spencertipping/caterwaul-bloom'>Bloom filters</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-struct'>C struct binary I/O</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-heap'>Heap</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-numeric'>Vector math</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-serialization'>Reference-safe serialization</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-regexp'>Regular expression parser</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-parser'>Nonlinear parser combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-invariant'>Invariant state propagation</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-futures'>Future monad</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-factory'>Value production combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-jquery-node'>Headless jQuery renderer</a></li>
</ul>

<h3><label for='college-projects'>College projects</label></h3>
<ul id='college-projects'>
<li><a href='http://github.com/spencertipping/mathbio2008'>MathBio summer research (2008)</a></li>
<li><a href='http://github.com/spencertipping/mcm2007'>MAA Mathematical contest in modeling (2007)</a></li>
</ul>

<h3><label for='questionable-ideas'>Questionable Ideas</label></h3>
<ul id='questionable-ideas'>
<li><a href='http://github.com/spencertipping/cpp-template-lisp'>Lisp in C++ templates</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ext4'>Caterwaul ext4 filesystem driver</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ruby'>Caterwaul Ruby syntax module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-terminal'>Caterwaul ANSI terminal module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-reflection'>Caterwaul deep reflection module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.hlasm'>Caterwaul 0.x high-level assembler</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.llasm'>Caterwaul 0.x low-level assembler</a></li>
<li><a href='http://github.com/spencertipping/rift'>Rift Ruby VM</a></li>
<li><a href='http://github.com/spencertipping/delimited-continuations-in-scheme'>Delimited continuations in Scheme</a></li>
<li><a href='http://github.com/spencertipping/instaserver'>Instaserver</a></li>
<li><a href='http://github.com/spencertipping/havoc'>Havoc programming language</a></li>
<li><a href='http://github.com/spencertipping/node-runabuf'>node.js run-a-buf</a></li>
<li><a href='http://github.com/spencertipping/js-typeclasses'>Javascript dynamic typeclasses</a></li>
</ul>

<h3><label for='epic-failures'>Epic Failures</label></h3>
<ul id='epic-failures'>
<li><a href='http://github.com/spencertipping/caterwaul-hijack'>Caterwaul parser hijack module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-c'>Caterwaul C syntax module</a></li>
<li><a href='http://github.com/spencertipping/divergence'>Divergence</a></li>
<li><a href='http://github.com/spencertipping/divergence.rebase'>Divergence Rebase</a></li>
<li><a href='http://github.com/spencertipping/gnarly'>Gnarly programming language</a></li>
<li><a href='http://github.com/spencertipping/figment'>Figment programming language</a></li>
<li><a href='http://github.com/spencertipping/montenegro'>Montenegro</a></li>
</ul>

<!-- Generated by SDoc -->

</div>

<div id='contents' role='main'>
<div id='post-2012.0819-clojure-metadata'>
  <span class='date'>2012.0819</span>
  <span class='permalink'><a href='/posts/2012.0819.clojure-metadata.html'>permalink</a></span>
  <div class='section level1'>
  <h1>Clojure metadata</h1>
  <p>I've finally gotten around to learning Clojure, and I have to say it's an
impressive and very usable piece of technology. At first I was worried that it
was a hack to get Common Lisp running on the JVM, but it's much more than that.
In general I've found it to be predictable and easy to learn, but one of the
counterintuitive parts of Clojure is the way it deals with metadata.</p>
  <p>When I first saw the metadata mechanism, I thought, "oh cool, we can attach
arbitrary maps to things", so I popped open the repl and tried to do exactly
that. I used the <code>^meta value</code> shorthand, since the documentation
states that it is a reader macro that expands to <code>with-meta</code>.</p>
  <pre class='quoted'>user&gt; (meta (with-meta 'a {:doc "hi"}))
{:doc "hi"}                   ; so far so good...
user&gt; (meta ^{:doc "hi"} 'a)
nil                           ; huh?
user&gt;</pre>
  <p>Clearly my understanding of metadata is a little off, but even more perplexing
is this:</p>
  <pre class='quoted'>user&gt; (meta (with-meta [] {:doc "hi"}))
{:doc "hi"}                   ; as expected...
user&gt; (meta ^{:doc "hi"} [])
{:doc "hi"}                   ; wtf!
user&gt;</pre>
  <p>So we can attach metadata to a vector but not a symbol?</p>
  <p>Here's the missing piece. <code>^meta value</code> is a reader macro, whereas
<code>with-meta</code> is a regular function call. This is important. You'll
notice that you can use metadata annotations inside of quoted values:</p>
  <pre class='quoted'>user&gt; '(a ^:b c)
(a c)
user&gt;</pre>
  <p>This is different from something like the <code>@x</code> reader macro (and, in
fact, nearly every other reader macro supported by Clojure):</p>
  <pre class='quoted'>user&gt; '(a @b c)
(a (clojure.core/deref b) c)
user&gt;</pre>
  <p>The difference is that in the case of quotation, dereferencing, unquoting, etc,
the reader generates a function call. In the case of metadata, the function call
happens inside the reader! This explains why we started losing metadata on
quoted symbols; here's what happened there:</p>
  <pre class='quoted'>;; the repl reads the input:
'(meta ^{:doc "hi"} 'a)               &lt;- initial list to be read
`(meta ~(with-meta 'a {:doc "hi"}))   &lt;- ^ reader macro
`(meta (quote a))                     &lt;- metadata is on the (quote a) list
;; the repl has read the list; it evaluates the result:
(eval '(meta (quote a)))              &lt;- metadata is still on (quote a)
((resolve meta) (eval (quote a)))     &lt;- eval rule for function calls
(&lt;meta&gt; a)                            &lt;- evaluate the argument</pre>
  <p>The metadata is lost when we evaluate <code>(quote a)</code>, which is a list
that contains metadata, into <code>a</code>, which is a symbol. This makes
sense; metadata shouldn't persist across evaluation.</p>
  <p>What about vectors? Here's the difference:</p>
  <pre class='quoted'>;; read:
'(meta ^{:doc "hi"} [])               &lt;- initial value to be read
`(meta ~(with-meta [] {:doc "hi"}))   &lt;- ^ reader macro
`(meta [])                            &lt;- metadata is on the [] vector
;; evaluate:
(eval '(meta []))                     &lt;- metadata is still on []
((resolve meta) (eval []))            &lt;- eval rule
(&lt;meta&gt; [])                           &lt;- [] evaluates to itself!</pre>
  <p>We don't lose the metadata here because the empty vector evaluates to itself and
therefore keeps whatever metadata it had at read-time. There is some strangeness
that comes about because of this:</p>
  <pre class='quoted'>user&gt; ^{:doc "hi"} [1 2 3]
[1 2 3]
user&gt; (meta *1)
{:doc "hi"}
user&gt; [1 2 3]
[1 2 3]
user&gt; (meta ^{:doc "hi"} *1)
nil
user&gt;</pre>
  <p>It's the same problem we had with the quoted symbol from before. The reader
hands us a symbol <code>*1</code> with metadata already on it, but
<code>eval</code> converts that metadata-laden symbol to the un-metadata-laden
vector <code>[1 2 3]</code> before <code>meta</code> can see it.</p>
  <p>The result of all of this behavior is that you are likely to see
<code>with-meta</code> in evaluative contexts; that is, within functions and
other normal expressions that will be processed by <code>eval</code>. Read-time
metadata makes more sense in any quoted context, including in macro arguments
(which themselves are quoted by Clojure when it sees that you're calling a
macro).</p>
  <p>This also means that the strange behavior of the reader macro is actually a
strong <em>feature</em>: it allows metadata to be value-transparent even before
the evaluation process. This results in nice properties like:</p>
  <pre class='quoted'>user&gt; (= '(a b c) '(a ^{:doc "hi"} b c))
true
user&gt;
</pre>
</div>
</div>

</div>
</body>
</html>
