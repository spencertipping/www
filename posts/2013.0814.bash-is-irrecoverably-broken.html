<!doctype html>
<html>
<head>
<meta charset='utf-8'/>
<style>
/* Blog stylesheet | Spencer Tipping*/
/* Licensed under the terms of the MIT source code license*/

body {font-family: 'Sans', sans-serif; font-size: 9pt; line-height: 1.44em; margin: 0 auto; max-width: 80ex}

a {color: #35a; text-decoration: none}
a:hover {text-decoration: underline}
a:visited {color: #89a}

#header {position: absolute; right: 0; top: 0; padding: 10px; text-align: right; font-size: 8pt}
#header h3 {font-size: 8pt; font-weight: normal}
#header ul {list-style-type: none}

#contents {padding: 10px 0}
#contents h1, #contents h2, #contents h3, #contents h4 {font-weight: normal; font-size: 14pt; text-transform: lowercase; margin: 0; padding: 10px 0}
#contents h2 {font-size: 10pt; color: #000; text-transform: uppercase}
#contents h3 {font-size: 10pt; color: #444; text-transform: uppercase} #contents h3:before {content: '> '; color: #888}
#contents h4 {font-size: 10pt; color: #888; text-transform: uppercase} #contents h4:before {content: '> '; color: #ccc}

#contents em {color: #444}

#contents .date      {color: #888; font-size: 10pt; font-family: 'Droid Sans Mono', 'Monospace', 'Liberation Mono', monospace; float: right; margin-top: 1em}
#contents .permalink {font-size: 10pt; float: right; margin-top: 1em}
#contents .permalink a {color: #888}
#contents .permalink a:after {color: #ccc; content: '|'}

td, th {text-align: right; border-right: solid 1px #ccc}

/* Generated by SDoc */

</style>
<link rel='alternate' href='feed.atom' type='application/atom+xml' title='Atom feed'/>
</head>
<body>
<div id='header' role='banner'>
<div><a href='http://twitter.com/spencertipping' aria-label='Twitter handle'>@spencertipping</a></div>
<div><a href='http://github.com/spencertipping' aria-label='Github profile'>github.com/spencertipping</a></div>
<div><a href='http://github.com/spencertipping/plain-blog'>Blog source</a></div>
<div><a href='http://spencertipping.com/zeroconsulting'>Zero-risk consulting</a></div>
<div><a href='http://spencertipping.com/feed.atom'>Atom feed</a></div>

<h3><label for='family'>Family</label></h3>
<ul id='family'>
<li><a href='http://joycetipping.com'>Joyce (my wife)</a></li>
<li><a href='http://adamtipping.com'>Adam (our son)</a></li>
</ul>

<h3><label for='projects'>Projects</label></h3>
<ul id='projects'>
<li><a href='http://github.com/spencertipping/cd'>cd</a></li>
<li><a href='http://github.com/spencertipping/perl-objects'>Self-modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/flotsam'>Flotsam</a></li>
<li><a href='http://github.com/spencertipping/js-instabench'>Javascript Instabench</a></li>
<li><a href='http://spencertipping.com/cheloniidae'>Cheloniidae</a></li>
<li><a href='http://github.com/spencertipping/sdoc'>SDoc</a></li>
<li><a href='http://github.com/spencertipping/bash-prompt'>Bash prompt</a></li>
<li><a href='http://github.com/spencertipping/rather-insane-serialization'>Rather Insane Serialization</a></li>
<li><a href='http://github.com/spencertipping/infuse'>Infuse JS</a></li>
<li><a href='http://github.com/spencertipping/browserpower'>Browserpower</a></li>
<li><a href='http://github.com/spencertipping/perlquery'>Perlquery</a></li>
<li><a href='http://github.com/spencertipping/cheloniidae-live'>Cheloniidae Live</a></li>
</ul>

<h3><label for='moreprojects'>Misguided but fun</label></h3>
<ul id='moreprojects'>
<li><a href='http://github.com/spencertipping/canard'>Canard</a></li>
<li><a href='http://github.com/spencertipping/caterwaul'>Caterwaul JS</a></li>
<li><a href='http://github.com/spencertipping/bash-lambda'>Bash-lambda</a></li>
<li><a href='http://github.com/spencertipping/catastrophe'>Catastrophe</a></li>
<li><a href='http://github.com/spencertipping/mulholland'>Mulholland</a></li>
</ul>

<h3><label for='quizzes'>Web quizzes</label></h3>
<ul id='quizzes'>
<li><a href='http://spencertipping.com/pl-quiz.html'>Programming language quiz</a></li>
<li><a href='http://spencertipping.com/js-quiz.html'>Javascript quiz</a></li>
</ul>

<h3><label for='pdfs'>PDFs</label></h3>
<ul id='pdfs'>
<li><a href='http://github.com/spencertipping/js-in-ten-minutes'>Javascript in Ten Minutes</a></li>
<li><a href='http://github.com/spencertipping/writing-self-modifying-perl'>Writing Self-Modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/git-in-ten-minutes'>Git in Ten Minutes</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-by-example.pdf'>Caterwaul by Example</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-reference-manual.pdf'>Caterwaul Reference Manual</a></li>
<li><a href='http://spencertipping.com/cheloniidae/cheloniidae.pdf'>Cheloniidae literate source</a></li>
<li><a href='http://spencertipping.com/mathbio2008/model.pdf'>MathBio model literate source</a></li>
</ul>

<h3><label for='jquery-modules'>jQuery modules</label></h3>
<ul id='jquery-modules'>
<li><a href='http://github.com/spencertipping/modus'>Modus (uses Caterwaul)</a></li>
<li><a href='http://github.com/spencertipping/jquery.instavalidate'>Instavalidate</a></li>
<li><a href='http://github.com/spencertipping/jquery.gaussian'>Gaussian blur</a></li>
<li><a href='http://github.com/spencertipping/jquery.fix.clone'>clone() patch</a></li>
</ul>

<h3><label for='caterwaul-modules'>Caterwaul modules</label></h3>
<ul id='caterwaul-modules'>
<li><a href='http://github.com/spencertipping/caterwaul-bloom'>Bloom filters</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-struct'>C struct binary I/O</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-heap'>Heap</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-numeric'>Vector math</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-serialization'>Reference-safe serialization</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-regexp'>Regular expression parser</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-parser'>Nonlinear parser combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-invariant'>Invariant state propagation</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-futures'>Future monad</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-factory'>Value production combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-jquery-node'>Headless jQuery renderer</a></li>
</ul>

<h3><label for='college-projects'>College projects</label></h3>
<ul id='college-projects'>
<li><a href='http://github.com/spencertipping/mathbio2008'>MathBio summer research (2008)</a></li>
<li><a href='http://github.com/spencertipping/mcm2007'>MAA Mathematical contest in modeling (2007)</a></li>
</ul>

<h3><label for='questionable-ideas'>Questionable Ideas</label></h3>
<ul id='questionable-ideas'>
<li><a href='http://github.com/spencertipping/cpp-template-lisp'>Lisp in C++ templates</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ext4'>Caterwaul ext4 filesystem driver</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ruby'>Caterwaul Ruby syntax module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-terminal'>Caterwaul ANSI terminal module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-reflection'>Caterwaul deep reflection module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.hlasm'>Caterwaul 0.x high-level assembler</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.llasm'>Caterwaul 0.x low-level assembler</a></li>
<li><a href='http://github.com/spencertipping/rift'>Rift Ruby VM</a></li>
<li><a href='http://github.com/spencertipping/delimited-continuations-in-scheme'>Delimited continuations in Scheme</a></li>
<li><a href='http://github.com/spencertipping/instaserver'>Instaserver</a></li>
<li><a href='http://github.com/spencertipping/havoc'>Havoc programming language</a></li>
<li><a href='http://github.com/spencertipping/node-runabuf'>node.js run-a-buf</a></li>
<li><a href='http://github.com/spencertipping/js-typeclasses'>Javascript dynamic typeclasses</a></li>
</ul>

<h3><label for='epic-failures'>Epic Failures</label></h3>
<ul id='epic-failures'>
<li><a href='http://github.com/spencertipping/caterwaul-hijack'>Caterwaul parser hijack module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-c'>Caterwaul C syntax module</a></li>
<li><a href='http://github.com/spencertipping/divergence'>Divergence</a></li>
<li><a href='http://github.com/spencertipping/divergence.rebase'>Divergence Rebase</a></li>
<li><a href='http://github.com/spencertipping/gnarly'>Gnarly programming language</a></li>
<li><a href='http://github.com/spencertipping/figment'>Figment programming language</a></li>
<li><a href='http://github.com/spencertipping/montenegro'>Montenegro</a></li>
</ul>

<!-- Generated by SDoc -->

</div>

<div id='contents' role='main'>
<div id='post-2013.0814-bash-is-irrecoverably-broken'>
  <span class='date'>2013.0814</span>
  <span class='permalink'><a href='/posts/2013.0814.bash-is-irrecoverably-broken.html'>permalink</a></span>
  <div class='section level1'>
  <h1>Bash is irrecoverably broken</h1>
  <p>Everybody knows that bash is a little weird. The quoting shenanigans with
<code>$@</code> and <code>$*</code>, the horked local scoping rules, the
required whitespace around <code>[[</code> and <code>]]</code>, and a
handful of other oddities that make shell scripting feel like an adventure. And
these were things I was happy to put up with in exchange for its convenient
ubiquity and highly usable default settings.</p>
  <p>That all changed this morning.</p>
  <p>I was up early to work on <a
href='http://github.com/spencertipping/bake'>bake</a>, a build tool that
integrates with the shell environment. Bake maintains a table of variable
bindings and uses these repeatedly when solving the dependency graph, so I
wrote up some quick benchmarks to test various strategies for storing and
accessing it.</p>
  <p>No problem, right? Bash has sparse arrays, global variables, and bash 4
introduces associative arrays. One way or another, we've got this covered. Ok,
so let's do a quick check to make sure the sparse-array support doesn't do
anything too crazy with access times:</p>
  <pre class='quoted'># setup xs to have 65536 elements, each one character long
benchmarking local x=${xs[1024]}...
user    0m0.234s
user    0m0.237s
user    0m0.234s
user    0m0.241s
benchmarking local x=${xs[16384]}...
user    0m0.233s
user    0m0.240s
user    0m0.242s
user    0m0.240s</pre>
  <p>Looks good! It doesn't seem to matter what the index is. So however bash is
doing arrays, it isn't doing anything crazy like a linear scan when we retrieve
stuff. Right?</p>
  <div class='section level2'>
    <h2>Arrays are linked lists</h2>
    <p>  Wrong. Sparse arrays are implemented as linked lists in bash. To optimize the
  sequential access case, the array structure contains a stateful pointer to
  the last element accessed. We can see this behavior in a benchmark by
  requesting element 0 after element N:</p>
    <pre class='quoted'>benchmarking local x=${xs[1024]} y=${xs[0]}...
user  0m0.347s
user  0m0.353s
user  0m0.349s
user  0m0.350s
benchmarking local x=${xs[16384]} y=${xs[0]}...
user  0m1.175s
user  0m1.183s
user  0m1.189s
user  0m1.182s</pre>
    <p>  A tragic lack of forethought on the part of the array implementer. But no
  matter; bash gives us at least two ways to access hash tables, so we can work
  around the problem that way.</p>
  </div>
  <div class='section level2'>
    <h2>Hash tables are linked lists</h2>
    <p>  Bash does not use hashtables as of version 4.2, and you should not use a
  hashtable written by anyone who tells you otherwise.</p>
    <p>  Yes, you read that correctly. Every variable lookup, every associative array
  lookup, alias lookup, etc -- these are all linear-time scans through a linked
  list.</p>
    <p>  In the bash source, there's a set of functions called
  <code>hash_create</code>, <code>hash_insert</code>, etc, that are
  unsurprisingly called whenever bash maintains a mapping from strings to other
  stuff like functions, variables, aliases, and such. And also unsurprisingly,
  there's a function that hashes strings by multiplying each character by a big
  prime number. So one might reasonably conclude that all this talk of hashes
  is about setting up a hash table for averaged constant-time access.</p>
    <p>  That was probably the idea, anyway. But if you benchmark variable lookups,
  you'll observe a noticeable decline in performance as more of them are
  defined:</p>
    <pre class='quoted'>setting up 64 vars...
real  0m0.004s
user  0m0.004s
sys   0m0.000s
benchmarking local x=${xs_0} y=${xs_0}...
user  0m0.260s
user  0m0.259s
user  0m0.258s
user  0m0.259s</pre>
    <pre class='quoted'>setting up 65536 vars...
real  0m7.484s
user  0m7.415s
sys   0m0.071s
benchmarking local x=${xs_0} y=${xs_0}...
user  0m2.905s
user  0m2.914s
user  0m2.927s
user  0m2.909s</pre>
    <p>  Let's give bash the benefit of the doubt here and say that maybe some of the
  later variables created some hash collisions (despite all being named
  <code>xs_i</code> for densely-distributed integers <code>i</code>). It isn't
  quite fair to compare a nearly-empty hashtable with a full one.</p>
    <pre class='quoted'>setting up 524288 vars...
real  12m4.956s
user  12m2.650s
sys   0m2.090s
benchmarking local x=${xs_0} y=${xs_0}...
user  1m20.455s
user  1m19.054s
user  1m17.574s
user  1m12.624s</pre>
    <p>  ZOMGWTF. Eight times as many variables, and a whopping 100x as long to set
  them up. 10x as long to access. And we're not swapping to disk or anything;
  this is all happening well within memory.</p>
    <p>  Clearly this is no ordinary hashtable implementation. And indeed, here is the
  <code>hash_insert</code> function from the source (reformatted for brevity):</p>
    <pre class='quoted'>BUCKET_CONTENTS *
hash_insert (string, table, flags)
     char *string;
     HASH_TABLE *table;
     int flags;
{
  BUCKET_CONTENTS *item;
  int bucket;
  unsigned int hv;
  if (table == 0) table = hash_create (0);
  item = (flags &amp; HASH_NOSRCH) ? (BUCKET_CONTENTS *)NULL
               : hash_search (string, table, 0);
  if (item == 0)
    {
      bucket = HASH_BUCKET (string, table, hv);
      item = (BUCKET_CONTENTS *)xmalloc (sizeof (BUCKET_CONTENTS));
      item-&gt;next = table-&gt;bucket_array[bucket];
      table-&gt;bucket_array[bucket] = item;
      item-&gt;data = NULL;
      item-&gt;key = string;
      item-&gt;khash = hv;
      item-&gt;times_found = 0;
      table-&gt;nentries++;
    }
  return (item);
}</pre>
    <p>  This all looks quite innocuous at first glance, but if you've ever written a
  hashtable you will quickly realize that something crucial is missing: <em>the
  bucket array is never resized</em>. Bash does us the service of maintaining
  an exact count of the number of items stored in the table, but at no point
  does it resize the array to maintain an average chain depth.</p>
    <p>  Which, of course, is something of a problem as we start to add more entries.
  What it really means is that bash isn't using a proper hashtable at all;
  instead, it's just a fixed number of linked lists over which it will
  ultimately do linear scans. This explains why creating n variables takes
  n<sup>2</sup> time.</p>
  </div>
  <div class='section level2'>
    <h2>Why this matters</h2>
    <p>  You might be thinking, "look, it's a shell, who cares." I was tempted to
  think this too, and for most people it probably really doesn't matter. But
  the shell isn't just this thing you type commands into. It's your window into
  the system. It's a programming language that you're using to tell the
  computer what to do. And being able to extend your navigational context is
  enormously helpful. Bash, through its sloppy implementation, reduces the
  shell to just a command prompt and not much more.</p>
    <p>  It's possible to overcome most kinds of limitations in one way or another.
  And I'm generally willing to go to some <a
  href='http://github.com/spencertipping/bash-lambda'>absurd lengths</a> to get
  something to work if it's sufficiently interesting. There are two kinds of
  problems, however, that force a hard stop. One is when you don't have enough
  computational expressiveness to do something, like trying to write Lisp in
  the C preprocessor. (You <a
  href='http://github.com/spencertipping/cpp-template-lisp'>can do it</a> with
  C++ template metaprogramming, but the C preprocessor isn't Turing-complete.)</p>
    <p>  The other is when you hit a performance barrier with no workaround. If you
  can allocate memory and get to it in constant time, you can probably come up
  with some creative solution to a performance problem; but this all stops when
  your language has no constant-time data access.</p>
    <p>  I guess it's time to switch to zsh:</p>
    <pre class='quoted'>if (++ht-&gt;ct &gt;= ht-&gt;hsize * 2 &amp;&amp; !ht-&gt;scan)
    expandhashtable(ht);</pre>
    <p>  Or maybe this will be enough motivation to write a shell. But either way,
  today is my last day using bash.
</p>
  </div>
</div>
</div>

</div>
</body>
</html>
