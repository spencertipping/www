<!doctype html>
<html>
<head>
<meta charset='utf-8'/>
<style>
/* Blog stylesheet | Spencer Tipping*/
/* Licensed under the terms of the MIT source code license*/

body {font-family: 'Sans', sans-serif; font-size: 9pt; line-height: 1.44em; margin: 0 auto; max-width: 80ex}

a {color: #35a; text-decoration: none}
a:hover {text-decoration: underline}
a:visited {color: #89a}

#header {position: absolute; right: 0; top: 0; padding: 10px; text-align: right; font-size: 8pt}
#header h3 {font-size: 8pt; font-weight: normal}
#header ul {list-style-type: none}

#contents {padding: 10px 0}
#contents h1, #contents h2, #contents h3, #contents h4 {font-weight: normal; font-size: 14pt; text-transform: lowercase; margin: 0; padding: 10px 0}
#contents h2 {font-size: 10pt; color: #000; text-transform: uppercase}
#contents h3 {font-size: 10pt; color: #444; text-transform: uppercase} #contents h3:before {content: '> '; color: #888}
#contents h4 {font-size: 10pt; color: #888; text-transform: uppercase} #contents h4:before {content: '> '; color: #ccc}

#contents em {color: #444}

#contents .date      {color: #888; font-size: 10pt; font-family: 'Droid Sans Mono', 'Monospace', 'Liberation Mono', monospace; float: right; margin-top: 1em}
#contents .permalink {font-size: 10pt; float: right; margin-top: 1em}
#contents .permalink a {color: #888}
#contents .permalink a:after {color: #ccc; content: '|'}

td, th {text-align: right; border-right: solid 1px #ccc}

/* Generated by SDoc */

</style>
<link rel='alternate' href='feed.atom' type='application/atom+xml' title='Atom feed'/>
</head>
<body>
<div id='header' role='banner'>
<div><a href='http://twitter.com/spencertipping' aria-label='Twitter handle'>@spencertipping</a></div>
<div><a href='http://github.com/spencertipping' aria-label='Github profile'>github.com/spencertipping</a></div>
<div><a href='http://github.com/spencertipping/plain-blog'>Blog source</a></div>
<div><a href='http://spencertipping.com/zeroconsulting'>Zero-risk consulting</a></div>
<div><a href='http://spencertipping.com/feed.atom'>Atom feed</a></div>

<h3><label for='family'>Family</label></h3>
<ul id='family'>
<li><a href='http://joycetipping.com'>Joyce (my wife)</a></li>
<li><a href='http://adamtipping.com'>Adam (our son)</a></li>
</ul>

<h3><label for='projects'>Projects</label></h3>
<ul id='projects'>
<li><a href='http://github.com/spencertipping/cd'>cd</a></li>
<li><a href='http://github.com/spencertipping/perl-objects'>Self-modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/flotsam'>Flotsam</a></li>
<li><a href='http://github.com/spencertipping/js-instabench'>Javascript Instabench</a></li>
<li><a href='http://spencertipping.com/cheloniidae'>Cheloniidae</a></li>
<li><a href='http://github.com/spencertipping/sdoc'>SDoc</a></li>
<li><a href='http://github.com/spencertipping/bash-prompt'>Bash prompt</a></li>
<li><a href='http://github.com/spencertipping/rather-insane-serialization'>Rather Insane Serialization</a></li>
<li><a href='http://github.com/spencertipping/infuse'>Infuse JS</a></li>
<li><a href='http://github.com/spencertipping/browserpower'>Browserpower</a></li>
<li><a href='http://github.com/spencertipping/perlquery'>Perlquery</a></li>
<li><a href='http://github.com/spencertipping/cheloniidae-live'>Cheloniidae Live</a></li>
</ul>

<h3><label for='moreprojects'>Misguided but fun</label></h3>
<ul id='moreprojects'>
<li><a href='http://github.com/spencertipping/canard'>Canard</a></li>
<li><a href='http://github.com/spencertipping/caterwaul'>Caterwaul JS</a></li>
<li><a href='http://github.com/spencertipping/bash-lambda'>Bash-lambda</a></li>
<li><a href='http://github.com/spencertipping/catastrophe'>Catastrophe</a></li>
<li><a href='http://github.com/spencertipping/mulholland'>Mulholland</a></li>
</ul>

<h3><label for='quizzes'>Web quizzes</label></h3>
<ul id='quizzes'>
<li><a href='http://spencertipping.com/pl-quiz.html'>Programming language quiz</a></li>
<li><a href='http://spencertipping.com/js-quiz.html'>Javascript quiz</a></li>
</ul>

<h3><label for='pdfs'>PDFs</label></h3>
<ul id='pdfs'>
<li><a href='http://github.com/spencertipping/js-in-ten-minutes'>Javascript in Ten Minutes</a></li>
<li><a href='http://github.com/spencertipping/writing-self-modifying-perl'>Writing Self-Modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/git-in-ten-minutes'>Git in Ten Minutes</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-by-example.pdf'>Caterwaul by Example</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-reference-manual.pdf'>Caterwaul Reference Manual</a></li>
<li><a href='http://spencertipping.com/cheloniidae/cheloniidae.pdf'>Cheloniidae literate source</a></li>
<li><a href='http://spencertipping.com/mathbio2008/model.pdf'>MathBio model literate source</a></li>
</ul>

<h3><label for='jquery-modules'>jQuery modules</label></h3>
<ul id='jquery-modules'>
<li><a href='http://github.com/spencertipping/modus'>Modus (uses Caterwaul)</a></li>
<li><a href='http://github.com/spencertipping/jquery.instavalidate'>Instavalidate</a></li>
<li><a href='http://github.com/spencertipping/jquery.gaussian'>Gaussian blur</a></li>
<li><a href='http://github.com/spencertipping/jquery.fix.clone'>clone() patch</a></li>
</ul>

<h3><label for='caterwaul-modules'>Caterwaul modules</label></h3>
<ul id='caterwaul-modules'>
<li><a href='http://github.com/spencertipping/caterwaul-bloom'>Bloom filters</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-struct'>C struct binary I/O</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-heap'>Heap</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-numeric'>Vector math</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-serialization'>Reference-safe serialization</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-regexp'>Regular expression parser</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-parser'>Nonlinear parser combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-invariant'>Invariant state propagation</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-futures'>Future monad</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-factory'>Value production combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-jquery-node'>Headless jQuery renderer</a></li>
</ul>

<h3><label for='college-projects'>College projects</label></h3>
<ul id='college-projects'>
<li><a href='http://github.com/spencertipping/mathbio2008'>MathBio summer research (2008)</a></li>
<li><a href='http://github.com/spencertipping/mcm2007'>MAA Mathematical contest in modeling (2007)</a></li>
</ul>

<h3><label for='questionable-ideas'>Questionable Ideas</label></h3>
<ul id='questionable-ideas'>
<li><a href='http://github.com/spencertipping/cpp-template-lisp'>Lisp in C++ templates</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ext4'>Caterwaul ext4 filesystem driver</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ruby'>Caterwaul Ruby syntax module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-terminal'>Caterwaul ANSI terminal module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-reflection'>Caterwaul deep reflection module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.hlasm'>Caterwaul 0.x high-level assembler</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.llasm'>Caterwaul 0.x low-level assembler</a></li>
<li><a href='http://github.com/spencertipping/rift'>Rift Ruby VM</a></li>
<li><a href='http://github.com/spencertipping/delimited-continuations-in-scheme'>Delimited continuations in Scheme</a></li>
<li><a href='http://github.com/spencertipping/instaserver'>Instaserver</a></li>
<li><a href='http://github.com/spencertipping/havoc'>Havoc programming language</a></li>
<li><a href='http://github.com/spencertipping/node-runabuf'>node.js run-a-buf</a></li>
<li><a href='http://github.com/spencertipping/js-typeclasses'>Javascript dynamic typeclasses</a></li>
</ul>

<h3><label for='epic-failures'>Epic Failures</label></h3>
<ul id='epic-failures'>
<li><a href='http://github.com/spencertipping/caterwaul-hijack'>Caterwaul parser hijack module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-c'>Caterwaul C syntax module</a></li>
<li><a href='http://github.com/spencertipping/divergence'>Divergence</a></li>
<li><a href='http://github.com/spencertipping/divergence.rebase'>Divergence Rebase</a></li>
<li><a href='http://github.com/spencertipping/gnarly'>Gnarly programming language</a></li>
<li><a href='http://github.com/spencertipping/figment'>Figment programming language</a></li>
<li><a href='http://github.com/spencertipping/montenegro'>Montenegro</a></li>
</ul>

<!-- Generated by SDoc -->

</div>

<div id='contents' role='main'>
<div id='post-2012.0611-how-modus-works'>
  <span class='date'>2012.0611</span>
  <span class='permalink'><a href='/posts/2012.0611.how-modus-works.html'>permalink</a></span>
  <div class='section level1'>
  <h1>How Modus works</h1>
  <p><a href='http://github.com/spencertipping/modus'>Modus</a> is a project I started a while ago and have largely left unmaintained. The idea was to let you use jQuery in
higher-order ways on lists or other structures of components. The canonical example is something like name/email:</p>
  <pre class='quoted'>&lt;div class='person' id='person1'&gt;
  &lt;input class='name'&gt;&lt;input class='email'&gt;
&lt;/div&gt;</pre>
  <p>Given the above HTML, you could use Modus like this:</p>
  <pre class='quoted'>$('.person').modus('composite', {name: '.name', email: '.email'});
$('#person1').val()   // -&gt; {name:  $('#person1 .name').val(),
                             email: $('#person1 .email').val()}</pre>
  <p>This morning I received an email from someone who is using Modus in production, asking for a line-by-line explanation of the source code. This is actually a great opportunity to explain some
things about what Caterwaul is doing, so here goes:</p>
  <p>First, Modus is written in Caterwaul, not Javascript. It ultimately gets compiled into Javascript, but <code>modus.waul.sdoc</code> is the human-readable source code and <code>modus.js</code>
is the unreadable Caterwaul output. <a href='http://github.com/spencertipping/sdoc'>SDoc</a> is a documentation format I wrote that basically auto-comments any paragraphs
beginning with an uppercase letter or pipe symbol. <code>waul</code>, the Caterwaul precompiler, understands SDoc syntax if the file ends in <code>.sdoc</code>.</p>
  <p>OK, so with that out of the way, here's the code (also <a href='http://github.com/spencertipping/modus/blob/master/modus.waul.sdoc'>on Github</a>), snippet by snippet:</p>
  <pre class='quoted'>caterwaul.module('modus', 'js_all', function ($) {</pre>
  <p>This defines a Caterwaul module transformed under the <code>js_all</code> set of macros. <code>js_all</code> includes all of the client/server-agnostic JS macros, but not
<code>jquery[]</code>. (We don't need <code>jquery</code> here because we don't create DOM nodes.)</p>
  <p>There are two reasons we create a module. First, it's one of the forms that <code>waul</code> understands. Technically, <code>waul</code> is doing something that isn't possible: it's
predicting the outcome of executing a bunch of Javascript and doing some work beforehand. The only reason this works is that it recognizes a few different toplevel forms and treats them
specially. The result is that any precompilable Caterwaul module is generally defined in its own file and starts with something like the module definition above.</p>
  <p>The second reason to define a module is that it will become a part of Caterwaul's replica if you end up calling <code>.replicate()</code>. Most people will never have a reason to do this.</p>
  <pre class='quoted'>$ = jQuery;</pre>
  <p>Obvious enough; we don't need the <code>$</code> reference that Caterwaul gives us, so we replace it with <code>jQuery</code>. Notice that this also gives us the shorthand <code>$ =
jQuery</code>, which is not true by default if the user has called <code>noConflict</code>.</p>
  <pre class='quoted'>var original_jquery_val = $.fn.val;
$.fn.val(args = arguments) = ...;</pre>
  <p>We're replacing jQuery's <code>val</code> method, so we need to first store the original and then redefine it. The second line uses Caterwaul's function definition syntax, which lets us bind
local variables:</p>
  <pre class='quoted'>f(x) = x + 1          // -&gt; f = function (x) {return x + 1}
f(x = 5) = x + 1      // -&gt; f = function () {
                                  var x = 5;
                                  return x + 1;
                                }</pre>
  <p>We need to store <code>arguments</code> because Caterwaul generates sub-functions for certain things, including the <code>-re</code> macro. If in doubt, always store the arguments. Here's the
actual function we're using to replace the original <code>val</code>:</p>
  <pre class='quoted'>$.fn.val(args = arguments) =
  this.data('modus') -re [it
    ? args.length ? it.setter.apply(this, args)
                  : it.getter.call(this)
    : original_jquery_val.apply(this, args)];</pre>
  <p>We're checking to see whether the current DOM node defines a <code>modus</code> data attribute; if it does, we use the getter and setter from that instead of the regular jQuery
<code>val</code>. Otherwise we use the original jQuery <code>val</code> function that we stored earlier. The <code>args.length</code> stuff is similar to jQuery's logic to use <code>val</code>
as both a getter and a setter:</p>
  <pre class='quoted'>myElement.val('foo')  // setter
myElement.val()       // getter</pre>
  <p>Modus takes care of this for you as a matter of convenience. The next bit of code is a little strange:</p>
  <pre class='quoted'>$.fn.modus(getter, setter) =
  getter.constructor === String
    ? use_named_combinator(this, arguments)
    : this.data('modus', {getter: getter, setter: setter}),
where [use_named_combinator(receiver, args) =
         $.modus[args[0]].apply(receiver,
                                Array.prototype.slice.call(args, 1))]</pre>
  <p>First I should point out that there are two <code>modus</code> objects. One is the method that is present on each jQuery collection; this is used to set up behavior for the elements in that
collection. The other <code>modus</code> is a global object on jQuery; this stores predefined behaviors that can be used later on (<code>list</code> and <code>composite</code> are two such
examples).</p>
  <p>With that said, the <code>$.fn.modus</code> method checks to see whether you're specifying the getter/setter functions as functions or in some other format. If <code>getter</code> is a string,
then it assumes you want to use a predefined behavior; otherwise it assumes you want to set the element's getter and setter directly. Predefined behaviors are expected to be defined as
attributes on the global <code>$.modus</code>, which we'll see more of in a moment.</p>
  <pre class='quoted'>$.modus = capture [
  util = {},</pre>
  <p>Here's where we set up the global <code>$.modus</code> object that ultimately will contain some useful element behaviors. <code>capture[]</code> is a macro that lets you use function
assignment syntax to initialize object key/value pairs:</p>
  <pre class='quoted'>capture [foo() = bar]   // -&gt; {foo: function () {return bar}}</pre>
  <p>I don't remember what I was using <code>util</code> for. There are three behaviors that come with Modus out of the box:</p>
  <div class='section level2'>
    <h2>Original val function</h2>
    <p>  This is not a behavior; it's just a utility function.</p>
    <pre class='quoted'>val() = original_jquery_val.apply(this, arguments),</pre>
    <p>  This is kind of subtle. Suppose you're writing a field that lower-cases its input using Modus. Here's how you might go about it at first:</p>
    <pre class='quoted'>$('.lowercase').modus(getter, setter)
-where [getter()  = this.val().toLowerCase(),
        setter(v) = this.val(v.toLowerCase())]</pre>
    <p>  The obvious problem here, however, is that you'll infinite-loop; <code>val</code> is a call to Modus, which will call your getter and setter functions all over again. What you want to do
  instead is use the original <code>val</code> from jQuery, which you can get to by asking Modus for it:</p>
    <pre class='quoted'>$('.lowercase').modus(getter, setter)
-where [getter()  = this.modus('val').toLowerCase(),
        setter(v) = this.modus('val', v.toLowerCase())]</pre>
  </div>
  <div class='section level2'>
    <h2>Delegate behavior</h2>
    <p>  This is where the behaviors start, and unfortunately with something of a hack.</p>
    <pre class='quoted'>delegate(getter, setter) = capture [
  first() = this,
  val()   = arguments.length
              ? getter.apply(this, arguments) -then- this
              : setter.apply(this, arguments)]</pre>
    <p>  This basically lets you assign one component's value to another one. You can imagine doing it for a single child:</p>
    <pre class='quoted'>&lt;div class='person-container'&gt;
  &lt;div class='person'&gt;
    ...
  &lt;/div&gt;
&lt;/div&gt;</pre>
    <p>  Here, you'd hook up <code>.person-container</code> to use the <code>val</code> function for <code>.person</code>:</p>
    <pre class='quoted'>$('.person-container').each(function () {
  var person = $(this).first('.person').data('modus');
  $(this).modus(person.getter, person.setter);
});</pre>
    <p>  I don't think I've ever used this behavior and can't remember why I wrote it in the first place.</p>
  </div>
  <div class='section level2'>
    <h2>List behavior</h2>
    <p>  This is the first combinator that is both useful and interesting. It constructs an array from the children of an element, and allows you to modify the children of an element by setting a new
  array of their values. The <code>new_element</code> constructor is used to convert from values to elements (more on this below).</p>
    <pre class='quoted'>list(new_element) = this.modus(
  "+this.children() *[$(x).val()] /seq".qf,
  "this.empty() -se- _ *![new_element(x).val(x) /!it.append] /seq".qf)</pre>
    <p>  This combinator is invoked when you write something like <code>element.modus('list', f)</code>. As you can see, it is setting up a getter and setter that close over the function you give it.
  In detail, here's what each one does.</p>
    <pre class='quoted'>"+this.children() *[$(x).val()] /seq".qf</pre>
    <p>  This is a closure that maps each child into its value. We start by grabbing the children of the Modus list, then using the prefix unary <code>+</code> to slice it into an <code>Array</code>
  instance (this is a <code>seq[]</code> macro feature). We then map (specified by <code>*</code>), and for every child element <code>x</code>, return <code>$(x).val()</code> -- thus
  retrieving the value. The result is bundled into an array that has the same ordering as the DOM nodes.</p>
    <pre class='quoted'>"this.empty() -se- _ *![new_element(x).val(x) /!it.append] /seq".qf</pre>
    <p>  This is the setter. First, we blow away all children in the node, since we're about to receive a new list. We then iterate through each new value (<code>*!</code>) and construct an element
  for it. There are a couple of things to notice here. First, <code>new_element</code> receives a copy of the value up-front. This helps you handle cases where there are several different
  value types that need different display elements (value polymorphism). Second, we then immediately set the value on the new component. This is more of a convenience than anything else; it
  just lets you omit a call to <code>.val()</code> on the new element if you want to simplify the <code>new_element</code> function.</p>
    <p>  Note that the <code>.qf</code> modifier on strings just builds a function out of the string's contents:</p>
    <pre class='quoted'>"_ + 1".qf  // -&gt; function (_) {return _ + 1}</pre>
    <p>  The other Caterwaul macro used here is <code>/!</code>, which is a way to wrap stuff into a function call while reducing the number of nested parentheses:</p>
    <pre class='quoted'>x /!f       // -&gt; f(x)
x /!o.f     // -&gt; o.f(x)</pre>
  </div>
  <div class='section level2'>
    <h2>Composite behavior</h2>
    <p>  This lets you map arbitrary descendants of elements to object keys. Unlike the list behavior, the composite behavior doesn't create or destroy elements; it just modifies the values of
  elements that are already in the DOM.</p>
    <pre class='quoted'>composite(paths) = this.modus(
  "paths %v* [find(this, x).first().val()] /seq".qf
  "paths %k*![find(this, paths[x]).first().val(_[x])] /seq /then.this".qf),
where [find(container, path) =
         path.constructor === String
           ? container.filter(path) /~add/ container.find(path)
           : path.constructor === Function
             ? path(container)
             : raise [new Error('invalid modus path: #{path}')]]</pre>
    <p>  Here, <code>paths</code> is an object that describes the name and location of each piece of the value. For example, consider a DOM container that looks like this:</p>
    <pre class='quoted'>&lt;div class='github-project'&gt;
  &lt;input class='name'&gt;
  &lt;input class='language'&gt;
  &lt;input class='branch'&gt;
&lt;/div&gt;</pre>
    <p>  We want an object that looks like <code>{name, language, branch}</code>. To get this, we just tell Modus which component each key corresponds to:</p>
    <pre class='quoted'>$('.github-project').modus('composite',
  {name:     'input.name',
   language: 'input.language',
   branch:   'input.branch'});
$('#my-project').val()      // -&gt; {name:     ...,
                                   language: ...,
                                   branch:   ...}</pre>
    <p>  Here's how the getter works:</p>
    <pre class='quoted'>"paths %v* [find(this, x).first().val()] /seq".qf</pre>
    <p>  We're doing a value-only map (<code>%v*</code> in the caterwaul <code>seq[]</code> library) over the <code>paths</code> object. This means that the object keys will remain the same, but
  we'll transform the values based on a map function. In this case, the values start out being paths and we're converting them to element values, which we do by first finding the component and
  then invoking the <code>val()</code> function. Notice, by the way, that we're not using the original jQuery <code>val</code>; we're using the Modus <code>val</code> method. This allows you
  to nest Modus components.</p>
    <p>  The setter is similar:</p>
    <pre class='quoted'>"paths %k*![find(this, paths[x]).first().val(_[x])] /seq /then.this".qf</pre>
    <p>  We're still going through the values in <code>paths</code>, but we need to hang onto the keys (using a for-each-key operation indicated by <code>%k*!</code>) so that we can grab the values
  of the value object we're setting, which is bound to the <code>_</code> variable by the <code>.qf</code> string modifier.</p>
    <p>  The most interesting part of the composite behavior is the <code>find</code> sub-function:</p>
    <pre class='quoted'>find(container, path) =
  path.constructor === String
    ? container.filter(path) /~add/ container.find(path)
    : path.constructor === Function
      ? path(container)
      : raise [new Error(...)]</pre>
    <p>  The goal here is to resolve a jQuery selector with respect to a container, but this is not as simple as you might expect. First, the user could specify a function instead of a string; that
  function is then called to return the sub-component. For example:</p>
    <pre class='quoted'>{name: function (container) {
         return container.find('.name');
       },
 language: '.language',
 ...}</pre>
    <p>  Second, the container itself could be a member of a multi-element collection that contributes to the value. (The second case is pathological and I'm not sure why I thought it mattered, but I
  decided to add it anyway.) To deal with this, we combine the <code>filter</code> output with the <code>find</code> output to make sure that we've included the containers themselves.</p>
    <p>  There are two new Caterwaul macros used in this section. One is <code>/~method/</code>, which works like this:</p>
    <pre class='quoted'>object /~method/ value      // -&gt; object.method(value)</pre>
    <p>  The other is <code>raise[]</code> which throws an error. This is useful because the <code>throw</code> keyword is illegal within an expression.</p>
    <p>  And that's it! Modus is just a combination of these few behaviors.
</p>
  </div>
</div>
</div>

</div>
</body>
</html>
