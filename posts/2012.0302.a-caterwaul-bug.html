<!doctype html>
<html>
<head>
<meta charset='utf-8'/>
<style>
/* Blog stylesheet | Spencer Tipping*/
/* Licensed under the terms of the MIT source code license*/

body {font-family: 'Sans', sans-serif; font-size: 9pt; line-height: 1.44em; margin: 0 auto; max-width: 80ex}

a {color: #35a; text-decoration: none}
a:hover {text-decoration: underline}
a:visited {color: #89a}

#header {position: absolute; right: 0; top: 0; padding: 10px; text-align: right; font-size: 8pt}
#header h3 {font-size: 8pt; font-weight: normal}
#header ul {list-style-type: none}

#contents {padding: 10px 0}
#contents h1, #contents h2, #contents h3, #contents h4 {font-weight: normal; font-size: 14pt; text-transform: lowercase; margin: 0; padding: 10px 0}
#contents h2 {font-size: 10pt; color: #000; text-transform: uppercase}
#contents h3 {font-size: 10pt; color: #444; text-transform: uppercase} #contents h3:before {content: '> '; color: #888}
#contents h4 {font-size: 10pt; color: #888; text-transform: uppercase} #contents h4:before {content: '> '; color: #ccc}

#contents em {color: #444}

#contents .date      {color: #888; font-size: 10pt; font-family: 'Droid Sans Mono', 'Monospace', 'Liberation Mono', monospace; float: right; margin-top: 1em}
#contents .permalink {font-size: 10pt; float: right; margin-top: 1em}
#contents .permalink a {color: #888}
#contents .permalink a:after {color: #ccc; content: '|'}

td, th {text-align: right; border-right: solid 1px #ccc}

/* Generated by SDoc */

</style>
<link rel='alternate' href='feed.atom' type='application/atom+xml' title='Atom feed'/>
</head>
<body>
<div id='header' role='banner'>
<div><a href='http://twitter.com/spencertipping' aria-label='Twitter handle'>@spencertipping</a></div>
<div><a href='http://github.com/spencertipping' aria-label='Github profile'>github.com/spencertipping</a></div>
<div><a href='http://github.com/spencertipping/plain-blog'>Blog source</a></div>
<div><a href='http://spencertipping.com/zeroconsulting'>Zero-risk consulting</a></div>
<div><a href='http://spencertipping.com/feed.atom'>Atom feed</a></div>

<h3><label for='family'>Family</label></h3>
<ul id='family'>
<li><a href='http://joycetipping.com'>Joyce (my wife)</a></li>
<li><a href='http://adamtipping.com'>Adam (our son)</a></li>
</ul>

<h3><label for='projects'>Projects</label></h3>
<ul id='projects'>
<li><a href='http://github.com/spencertipping/cd'>cd</a></li>
<li><a href='http://github.com/spencertipping/perl-objects'>Self-modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/flotsam'>Flotsam</a></li>
<li><a href='http://github.com/spencertipping/js-instabench'>Javascript Instabench</a></li>
<li><a href='http://spencertipping.com/cheloniidae'>Cheloniidae</a></li>
<li><a href='http://github.com/spencertipping/sdoc'>SDoc</a></li>
<li><a href='http://github.com/spencertipping/bash-prompt'>Bash prompt</a></li>
<li><a href='http://github.com/spencertipping/rather-insane-serialization'>Rather Insane Serialization</a></li>
<li><a href='http://github.com/spencertipping/infuse'>Infuse JS</a></li>
<li><a href='http://github.com/spencertipping/browserpower'>Browserpower</a></li>
<li><a href='http://github.com/spencertipping/perlquery'>Perlquery</a></li>
<li><a href='http://github.com/spencertipping/cheloniidae-live'>Cheloniidae Live</a></li>
</ul>

<h3><label for='moreprojects'>Misguided but fun</label></h3>
<ul id='moreprojects'>
<li><a href='http://github.com/spencertipping/canard'>Canard</a></li>
<li><a href='http://github.com/spencertipping/caterwaul'>Caterwaul JS</a></li>
<li><a href='http://github.com/spencertipping/bash-lambda'>Bash-lambda</a></li>
<li><a href='http://github.com/spencertipping/catastrophe'>Catastrophe</a></li>
<li><a href='http://github.com/spencertipping/mulholland'>Mulholland</a></li>
</ul>

<h3><label for='quizzes'>Web quizzes</label></h3>
<ul id='quizzes'>
<li><a href='http://spencertipping.com/pl-quiz.html'>Programming language quiz</a></li>
<li><a href='http://spencertipping.com/js-quiz.html'>Javascript quiz</a></li>
</ul>

<h3><label for='pdfs'>PDFs</label></h3>
<ul id='pdfs'>
<li><a href='http://github.com/spencertipping/js-in-ten-minutes'>Javascript in Ten Minutes</a></li>
<li><a href='http://github.com/spencertipping/writing-self-modifying-perl'>Writing Self-Modifying Perl</a></li>
<li><a href='http://github.com/spencertipping/git-in-ten-minutes'>Git in Ten Minutes</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-by-example.pdf'>Caterwaul by Example</a></li>
<li><a href='http://caterwauljs.org/doc/caterwaul-reference-manual.pdf'>Caterwaul Reference Manual</a></li>
<li><a href='http://spencertipping.com/cheloniidae/cheloniidae.pdf'>Cheloniidae literate source</a></li>
<li><a href='http://spencertipping.com/mathbio2008/model.pdf'>MathBio model literate source</a></li>
</ul>

<h3><label for='jquery-modules'>jQuery modules</label></h3>
<ul id='jquery-modules'>
<li><a href='http://github.com/spencertipping/modus'>Modus (uses Caterwaul)</a></li>
<li><a href='http://github.com/spencertipping/jquery.instavalidate'>Instavalidate</a></li>
<li><a href='http://github.com/spencertipping/jquery.gaussian'>Gaussian blur</a></li>
<li><a href='http://github.com/spencertipping/jquery.fix.clone'>clone() patch</a></li>
</ul>

<h3><label for='caterwaul-modules'>Caterwaul modules</label></h3>
<ul id='caterwaul-modules'>
<li><a href='http://github.com/spencertipping/caterwaul-bloom'>Bloom filters</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-struct'>C struct binary I/O</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-heap'>Heap</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-numeric'>Vector math</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-serialization'>Reference-safe serialization</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-regexp'>Regular expression parser</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-parser'>Nonlinear parser combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-invariant'>Invariant state propagation</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-futures'>Future monad</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-factory'>Value production combinators</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-jquery-node'>Headless jQuery renderer</a></li>
</ul>

<h3><label for='college-projects'>College projects</label></h3>
<ul id='college-projects'>
<li><a href='http://github.com/spencertipping/mathbio2008'>MathBio summer research (2008)</a></li>
<li><a href='http://github.com/spencertipping/mcm2007'>MAA Mathematical contest in modeling (2007)</a></li>
</ul>

<h3><label for='questionable-ideas'>Questionable Ideas</label></h3>
<ul id='questionable-ideas'>
<li><a href='http://github.com/spencertipping/cpp-template-lisp'>Lisp in C++ templates</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ext4'>Caterwaul ext4 filesystem driver</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-ruby'>Caterwaul Ruby syntax module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-terminal'>Caterwaul ANSI terminal module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-reflection'>Caterwaul deep reflection module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.hlasm'>Caterwaul 0.x high-level assembler</a></li>
<li><a href='http://github.com/spencertipping/caterwaul.llasm'>Caterwaul 0.x low-level assembler</a></li>
<li><a href='http://github.com/spencertipping/rift'>Rift Ruby VM</a></li>
<li><a href='http://github.com/spencertipping/delimited-continuations-in-scheme'>Delimited continuations in Scheme</a></li>
<li><a href='http://github.com/spencertipping/instaserver'>Instaserver</a></li>
<li><a href='http://github.com/spencertipping/havoc'>Havoc programming language</a></li>
<li><a href='http://github.com/spencertipping/node-runabuf'>node.js run-a-buf</a></li>
<li><a href='http://github.com/spencertipping/js-typeclasses'>Javascript dynamic typeclasses</a></li>
</ul>

<h3><label for='epic-failures'>Epic Failures</label></h3>
<ul id='epic-failures'>
<li><a href='http://github.com/spencertipping/caterwaul-hijack'>Caterwaul parser hijack module</a></li>
<li><a href='http://github.com/spencertipping/caterwaul-c'>Caterwaul C syntax module</a></li>
<li><a href='http://github.com/spencertipping/divergence'>Divergence</a></li>
<li><a href='http://github.com/spencertipping/divergence.rebase'>Divergence Rebase</a></li>
<li><a href='http://github.com/spencertipping/gnarly'>Gnarly programming language</a></li>
<li><a href='http://github.com/spencertipping/figment'>Figment programming language</a></li>
<li><a href='http://github.com/spencertipping/montenegro'>Montenegro</a></li>
</ul>

<!-- Generated by SDoc -->

</div>

<div id='contents' role='main'>
<div id='post-2012.0302-a-caterwaul-bug'>
  <span class='date'>2012.0302</span>
  <span class='permalink'><a href='/posts/2012.0302.a-caterwaul-bug.html'>permalink</a></span>
  <div class='section level1'>
  <h1>A Caterwaul bug</h1>
  <p>Not all bugs are created equal. They range from the stupidly obvious mistakes of late-night coding to the intriguingly subtle nonlocal consequences of reasonable design decisions. In my
experience, most bugs tend towards the obvious side of this scale. But sometimes I run into a legendary bit of pathology that is so convoluted or mysterious that it qualifies as a work of art.
Yesterday I was fortunate enough to encounter one of these in Caterwaul.</p>
  <p>I was a little worried about it because I had seen it happen at least once before and had no idea why. The symptom was that, for some input programs that made heavy use of syntax quotation,
<code>waul</code> would die with output similar to the following:</p>
  <pre class='quoted'>node.js:201
      throw e; // process.nextTick error, or 'error' event on first tick
            ^
TypeError: Object , has no method 'reach'
    at eval at &lt;anonymous&gt; (waul-1.2:140:119)
    at [object Object].each (eval at &lt;anonymous&gt; (waul-1.2:140:119))
    at [object Object].reach (eval at &lt;anonymous&gt; (waul-1.2:140:119))
    at eval at &lt;anonymous&gt; (waul-1.2:140:119)
    at [object Object].each (eval at &lt;anonymous&gt; (waul-1.2:140:119))
    at [object Object].reach (eval at &lt;anonymous&gt; (waul-1.2:140:119))
    at eval at &lt;anonymous&gt; (waul-1.2:140:119)
    at [object Object].each (eval at &lt;anonymous&gt; (waul-1.2:140:119))
    at [object Object].reach (eval at &lt;anonymous&gt; (waul-1.2:140:119))
    at eval at &lt;anonymous&gt; (waul-1.2:140:119)</pre>
  <p>One of the problems with writing your own programming language is that you also have to write your own debugger. Right now Caterwaul has no debugger, so figuring out why this was happening was
a real challenge. Fortunately, I had a hunch: I suspected that I was building a syntax tree with a string child instead of a syntax tree child. Caterwaul lets you use either as a convenience,
but the <code>push()</code> method of syntax trees doesn't do that conversion. So I refactored <code>push()</code> to use the same logic as the constructor and figured that would take care of
it.</p>
  <p>It didn't.</p>
  <p>Instead, I saw this in the generated output:</p>
  <pre class='quoted'>... .call(this, ..., , , , , , , , );</pre>
  <p>Node was understandably unhappy. Also strange was that my <code>.qse</code> literal expression refs had been replaced by variables called <code>e1</code>, <code>e2</code>, etc (normally they'd
be called <code>qse1</code>, <code>qse2</code>, ...). At first I thought I had some macro that was re-expanding something and generating anonymous expression refs, so I poked around. To my
surprise, no macro like this existed in the Caterwaul standard library. This meant that the bug was in the Caterwaul core itself.</p>
  <p>I copied the failing program and started trimming it down until the problem went away. I found out that constructs like <code>'g[_x]'.qse /-f/ y</code> would cause an <code>e</code> variable
to be created. As soon as I got rid of the <code>/-f/ y</code>, the <code>qse</code> would behave normally. I then tried it out on the REPL and found the same strange behavior:</p>
  <pre class='quoted'>$ waul -c js_all
waul&gt; '"foo".qse /-f/ bar'.qse.toString()
'f(qse_h_azCSgoP86KF16yaWYRruza)'             &lt;- notice: no 'bar'!
waul&gt; '"foo".qse / z /-f/ bar'.qse.toString()
'f(qse_j_azCSgoP86KF16yaWYRruza,z,bar)'       &lt;- now it's there</pre>
  <p>At this point it was clear that it was some strange case of the infix function syntax. After some more poking around and random guesses, I found that calling <code>flatten()</code> on
expression refs didn't work correctly. It turns out that tree coercion had a subtle bug in this function (it's written on one line in the Caterwaul source):</p>
  <pre class='quoted'>as: function (d) {
  return this.data === d
    ? this
    : new this.constructor(d).push(this);
}</pre>
  <p>This appeared to be doing the right thing: Either return the node or wrap it in a new <code>d</code> node and return that. It would be appropriately generic, too: <code>new
this.constructor</code> would be closed over the node type.</p>
  <p>And that's when everything made sense. Expression refs aren't instantiated like regular nodes. Most syntax trees take the "data", or their name, as the first argument. So if you said <code>new
caterwaul.syntax('foo')</code>, you'd have a syntax tree representing the identifier <code>foo</code>. But the expression ref and closure ref constructors are front-loaded to take the value
before the name. The name is entirely optional; normally Caterwaul will just use a gensym.</p>
  <p>The result of this was that when <code>flatten</code> was called on an expression ref, the expression ref was parenting itself with another expression ref, not a regular syntax node.
Expression refs don't have children, so this caused the original expression ref to be hidden and replaced by a nullary comma node. Expression refs serialize to their data, so the nullary comma
would be serialized as just ',', hence the syntactically incorrect output.</p>
  <p>Long story short, it turns out that <code>as</code> is an anomaly among tree transform methods in that it shouldn't respect type closure. The fix was to write it this way:</p>
  <pre class='quoted'>as: function (d) {
  return this.data === d
    ? this
    : new caterwaul_global.syntax(d).push(this);
}</pre>
  <p>If only all bugs could be this cool.
</p>
</div>
</div>

</div>
</body>
</html>
